import{r as m,l as fe,c as S,b as l,V as t,X as u,Z as s,W as _,T as i,u as _e,o as M,$ as g,w as ve,a2 as ge,a3 as ye,F as be,d as Ve,f as $}from"./index-ConCm_F-.js";import{Q as L,a as B,b as q,d as we,c as P,e as j}from"./QTable-BUWrZeTf.js";import{Q as I,a as Ce}from"./QForm-h3V9JM0e.js";import{Q as R,a as Q}from"./QCard-BirL4X1V.js";import{Q as p}from"./QInput-Cz8fbQWQ.js";import{m as he,n as xe}from"./format-MEHmbXNd.js";import{Q as qe}from"./QSpace-CItrBRwI.js";import{Q as Pe}from"./QSpinnerDots-fUqsc9C3.js";import{a as F,Q as G,C as H}from"./axios2-DnkUwo0C.js";import{u as Ie}from"./use-quasar-CWqgSqmt.js";import{i as K}from"./axios-R6vW24p9.js";import"./use-dark-Df08ketR.js";import"./index-DW_MHI2K.js";const Qe={class:"invoice-container"},Fe={class:"content-card fade-in"},Ue={class:"header-section"},De={class:"flex justify-between items-center"},Ee={class:"header-title"},ke={class:"full-width row flex-center q-pa-md text-grey-8"},Ne={class:"text-center"},Se={class:"flex justify-center space-x-2"},Me={class:"text-h6"},Te={class:"form-section"},Ae={class:"section-title"},Oe={class:"form-grid"},ze={class:"form-section"},$e={class:"section-title"},Le={class:"form-grid"},Be={class:"form-section"},je={class:"section-title"},Re={class:"form-grid"},Ge={class:"form-section"},He={class:"section-title"},Ke={class:"form-section"},We={class:"section-title"},Xe={class:"flex justify-between items-start q-pa-sm"},Ze={class:"text-subtitle1 text-weight-medium"},Je={class:"form-grid q-pa-sm"},Ye={class:"form-section"},ea={class:"section-title"},aa={class:"text-h6"},va={__name:"GenerarF",setup(ta){const c=Ie(),W=_e(),b=m([]),U=m([]),D=m([]),V=m(!1),w=m(!1),C=m(!0),y=m(null),h=m([]),v=m(!1),X=[{id:10,name:"Estándar"}],Z=[{id:"1",name:"Contado"},{id:"2",name:"Crédito"}],J=[{id:"10",name:"Efectivo"},{id:"20",name:"Cheque"},{id:"30",name:"Transferencia"},{id:"40",name:"Tarjeta Crédito"},{id:"50",name:"Tarjeta Débito"}],x=m({sortBy:"number",descending:!1,page:1,rowsPerPage:10,rowsNumber:0}),n=m({numbering_range_id:"",reference_code:"",observation:"",payment_form:"1",payment_due_date:"",payment_method_code:"10",operation_type:10,order_reference:{reference_code:"ref-001",issue_date:new Date().toISOString().split("T")[0]},billing_period:{start_date:"",start_time:"00:00:00",end_date:"",end_time:"23:59:59"},customer:{identification:"",dv:"",company:"",trade_name:"",names:"",address:"",email:"",phone:"",legal_organization_id:"",tribute_id:"21",identification_document_id:"",municipality_id:""},items:[]}),Y=[{name:"number",required:!0,label:"Factura N°",align:"left",field:"number",sortable:!0},{name:"names",label:"Cliente",field:"names",sortable:!0,style:"min-width: 200px; white-space: normal;"},{name:"total",label:"Total",field:"total",format:a=>E(a),sortable:!0,align:"right"},{name:"created_at",label:"Fecha Creación",field:"created_at",format:a=>ae(a,!1),sortable:!0},{name:"status",label:"Estado",field:a=>T(a.status),sortable:!0,align:"center"},{name:"actions",label:"Acciones",field:"actions",align:"center",style:"width: 150px"}],ee=[{name:"code_reference",required:!0,label:"Código",align:"left",field:"code_reference"},{name:"name",required:!0,label:"Nombre",align:"left",field:"name"},{name:"price",label:"Precio",field:"price"}];function E(a){return typeof a!="number"&&(a=parseFloat(a)),new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(isNaN(a)?0:a)}function ae(a,o=!0){if(!a)return"N/A";try{const e=new Date(a);if(isNaN(e.getTime())){const r=a.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2}):(\d{2}) (AM|PM)/);if(r){let f=parseInt(r[4],10);r[7]==="PM"&&f<12&&(f+=12),r[7]==="AM"&&f===12&&(f=0);const z=new Date(r[3],r[2]-1,r[1],f,r[5],r[6]);if(!isNaN(z.getTime())){const N={year:"numeric",month:"short",day:"numeric"};return o&&(N.hour="2-digit",N.minute="2-digit"),z.toLocaleDateString("es-CO",N)}}return a}const d={year:"numeric",month:"short",day:"numeric"};return o&&(d.hour="2-digit",d.minute="2-digit"),e.toLocaleDateString("es-CO",d)}catch{return a}}function te(a){return a===1?"positive":a===0?"warning":"negative"}function T(a){return a===1?"Activa":a===0?"Pendiente":"Inactiva/Error"}fe(async()=>{C.value=!0;try{await Promise.all([k(),oe(),ie()])}catch(a){console.error("Error loading initial data:",a),c&&c.notify({type:"negative",message:"Error cargando datos iniciales",position:"top"})}finally{C.value=!1}});async function k(){var a,o,e;try{const d=await K.get("/v1/bills");((a=d.data)==null?void 0:a.status)==="OK"&&((e=(o=d.data)==null?void 0:o.data)!=null&&e.data)?(b.value=d.data.data.data,d.data.data.pagination&&(x.value={...x.value,rowsNumber:d.data.data.pagination.total,rowsPerPage:d.data.data.pagination.per_page,page:d.data.data.pagination.current_page})):(b.value=[],console.warn("Unexpected response format:",d.data))}catch(d){console.error("Error fetching invoices:",d),c&&c.notify({type:"negative",message:"Error cargando facturas",position:"top"}),b.value=[]}}async function oe(){try{const a=await F.get("/usuarios/");U.value=Array.isArray(a.data)?a.data:[]}catch(a){console.error("Error fetching customers:",a),U.value=[]}}async function ie(){try{const a=await F.get("/productos/");D.value=Array.isArray(a.data)?a.data:[]}catch(a){console.error("Error fetching products:",a),D.value=[]}}function ne(a){a&&(n.value.customer={identification:a.identification,dv:a.dv||"",company:a.company||"",trade_name:a.trade_name||"",names:a.names,address:a.address,email:a.email,phone:a.phone,legal_organization_id:a.legal_organization_id,tribute_id:a.tribute_id||"21",identification_document_id:a.identification_document_id,municipality_id:a.municipality_id})}function le(){w.value=!0,h.value=[]}function re(){h.value.forEach(a=>{n.value.items.find(e=>e.code_reference===a.code_reference)||n.value.items.push({scheme_id:a.scheme_id||"0",code_reference:a.code_reference,name:a.name,quantity:1,discount_rate:a.discount_rate||0,price:a.price,tax_rate:a.tax_rate,unit_measure_id:a.unit_measure_id,standard_code_id:a.standard_code_id,is_excluded:a.is_excluded,tribute_id:a.tribute_id,withholding_taxes:[]})}),w.value=!1}function se(a){n.value.items.splice(a,1)}async function A(){var a,o,e,d;if(!v.value){v.value=!0;try{if(!n.value.items.length){c.notify({type:"warning",message:"Debe agregar al menos un producto",position:"top"}),v.value=!1;return}if(!y.value){c.notify({type:"warning",message:"Debe seleccionar un cliente",position:"top"}),v.value=!1;return}n.value.order_reference.reference_code||(n.value.order_reference.reference_code="ref-001"),n.value.order_reference.issue_date||(n.value.order_reference.issue_date=new Date().toISOString().split("T")[0]);const r=await K.post("/v1/bills/validate",n.value);if(r.data&&(r.data.isValid===!0||(a=r.data.message)!=null&&a.includes("registrado y validado con éxito"))){await F.post("/facturas/",n.value),c.notify({type:"positive",message:"Factura generada y validada correctamente ✨",icon:"sentiment_very_satisfied",color:"green-5",textColor:"white",position:"top",timeout:5e3,actions:[{icon:"close",color:"white"}]}),await k(),O();const f=((o=r.data)==null?void 0:o.message)||"Error en la validación de la factura";f.includes("registrado y validado con éxito")||c.notify({type:"negative",message:f,position:"top",timeout:5e3})}}catch(r){console.error("Error al procesar factura:",r);const f=((d=(e=r.response)==null?void 0:e.data)==null?void 0:d.message)||"Error al procesar la factura";c.notify({type:"negative",message:f,position:"top",timeout:5e3})}finally{v.value=!1}}}async function de(a){try{await F.delete(`/facturas/${a}`),await k(),c&&c.notify({type:"positive",message:"Factura eliminada correctamente",position:"top"})}catch(o){console.error("Error al eliminar factura:",o),c&&c.notify({type:"negative",message:"No se pudo eliminar la factura",position:"top"})}}function ue(a){W.push({name:"InvoiceDetail",params:{id:a.id},meta:{invoiceData:{...a}}})}function ce(){V.value=!0}function O(){V.value=!1,me()}function me(){n.value={numbering_range_id:"",reference_code:"",observation:"",payment_form:"1",payment_due_date:"",payment_method_code:"10",operation_type:10,order_reference:{reference_code:"ref-001",issue_date:new Date().toISOString().split("T")[0]},billing_period:{start_date:"",start_time:"00:00:00",end_date:"",end_time:"23:59:59"},customer:{identification:"",dv:"",company:"",trade_name:"",names:"",address:"",email:"",phone:"",legal_organization_id:"",tribute_id:"21",identification_document_id:"",municipality_id:""},items:[]},y.value=null}async function pe(a){console.log("Quick print for invoice:",a.number),c.notify({type:"info",message:`Preparando impresión rápida para ${a.number}... (funcionalidad completa en Detalle)`})}return(a,o)=>(M(),S("div",Qe,[l("div",Fe,[l("div",Ue,[l("div",De,[l("h2",Ee,[t(s,{name:"receipt_long",size:"2rem",class:"q-mr-sm"}),o[15]||(o[15]=u(" Gestión de Facturas "))]),t(_,{color:"white","text-color":"primary",label:"Crear Nueva Factura",onClick:ce,class:"action-button",disable:C.value,icon:"add_circle"},null,8,["disable"])])]),t(L,{rows:b.value,columns:Y,"row-key":"id",loading:C.value,class:"invoice-table",pagination:x.value,"onUpdate:pagination":o[0]||(o[0]=e=>x.value=e),"rows-per-page-options":[10,20,50],"binary-state-sort":""},{loading:i(()=>o[16]||(o[16]=[l("div",{class:"loading-overlay"},[l("div",{class:"loading-spinner"})],-1)])),"no-data":i(()=>[l("div",ke,[l("div",Ne,[t(s,{name:"receipt_long",size:"4rem",color:"grey-4"}),o[17]||(o[17]=l("p",{class:"text-h6 text-grey-8 q-mt-md"},"No hay facturas registradas",-1)),o[18]||(o[18]=l("p",{class:"text-grey-6"},"Comienza creando una nueva factura",-1))])])]),"body-cell-total":i(e=>[t(q,{props:e},{default:i(()=>[u(g(E(e.value)),1)]),_:2},1032,["props"])]),"body-cell-status":i(e=>[t(q,{props:e},{default:i(()=>[t(we,{color:te(e.row.status),"text-color":"white",size:"sm",class:"q-px-sm"},{default:i(()=>[u(g(T(e.row.status)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-actions":i(e=>[t(q,{props:e,class:"text-center"},{default:i(()=>[l("div",Se,[t(_,{icon:"visibility",flat:"",dense:"",color:"info",onClick:d=>ue(e.row),class:"action-button"},{default:i(()=>[t(I,null,{default:i(()=>o[19]||(o[19]=[u("Ver detalles")])),_:1})]),_:2},1032,["onClick"]),t(_,{icon:"print",flat:"",dense:"",color:"primary",onClick:d=>pe(e.row),class:"action-button"},{default:i(()=>[t(I,null,{default:i(()=>o[20]||(o[20]=[u("Imprimir factura (lista)")])),_:1})]),_:2},1032,["onClick"]),t(_,{icon:"delete",flat:"",dense:"",color:"negative",onClick:d=>de(e.row.id),class:"action-button"},{default:i(()=>[t(I,null,{default:i(()=>o[21]||(o[21]=[u("Eliminar factura")])),_:1})]),_:2},1032,["onClick"])])]),_:2},1032,["props"])]),_:1},8,["rows","loading","pagination"])]),t(B,{modelValue:V.value,"onUpdate:modelValue":o[12]||(o[12]=e=>V.value=e),persistent:"",maximized:""},{default:i(()=>[t(R,{class:"modal-card"},{default:i(()=>[t(Q,{class:"modal-header"},{default:i(()=>[l("div",Me,[t(s,{name:"add_circle",class:"q-mr-sm"}),o[22]||(o[22]=u(" Crear Nueva Factura "))])]),_:1}),t(Q,{class:"modal-body"},{default:i(()=>[t(Ce,{onSubmit:ve(A,["prevent"]),class:"invoice-form"},{default:i(()=>[l("div",Te,[l("div",Ae,[t(s,{name:"description"}),o[23]||(o[23]=u(" Información Básica "))]),l("div",Oe,[t(p,{modelValue:n.value.reference_code,"onUpdate:modelValue":o[1]||(o[1]=e=>n.value.reference_code=e),label:"Código de Referencia",outlined:"",required:"",rules:[e=>!!e||"El código es requerido"],class:"form-field"},{prepend:i(()=>[t(s,{name:"qr_code"})]),_:1},8,["modelValue","rules"]),t(P,{modelValue:n.value.operation_type,"onUpdate:modelValue":o[2]||(o[2]=e=>n.value.operation_type=e),options:X,"option-value":"id","option-label":"name",label:"Tipo de Operación",outlined:"","emit-value":"","map-options":"",required:"",rules:[e=>!!e||"El tipo de operación es requerido"],class:"form-field"},{prepend:i(()=>[t(s,{name:"settings"})]),_:1},8,["modelValue","rules"])])]),l("div",ze,[l("div",$e,[t(s,{name:"payments"}),o[24]||(o[24]=u(" Información de Pago "))]),l("div",Le,[t(P,{modelValue:n.value.payment_form,"onUpdate:modelValue":o[3]||(o[3]=e=>n.value.payment_form=e),options:Z,"option-value":"id","option-label":"name",label:"Forma de Pago",outlined:"","emit-value":"","map-options":"",required:"",rules:[e=>!!e||"La forma de pago es requerida"],class:"form-field"},{prepend:i(()=>[t(s,{name:"account_balance_wallet"})]),_:1},8,["modelValue","rules"]),t(p,{modelValue:n.value.payment_due_date,"onUpdate:modelValue":o[4]||(o[4]=e=>n.value.payment_due_date=e),type:"date",label:"Fecha de Vencimiento",outlined:"",required:"",rules:[e=>!!e||"La fecha de vencimiento es requerida"],class:"form-field"},{prepend:i(()=>[t(s,{name:"event"})]),_:1},8,["modelValue","rules"]),t(P,{modelValue:n.value.payment_method_code,"onUpdate:modelValue":o[5]||(o[5]=e=>n.value.payment_method_code=e),options:J,"option-value":"id","option-label":"name",label:"Método de Pago",outlined:"","emit-value":"","map-options":"",required:"",rules:[e=>!!e||"El método de pago es requerido"],class:"form-field"},{prepend:i(()=>[t(s,{name:"credit_card"})]),_:1},8,["modelValue","rules"])])]),l("div",Be,[l("div",je,[t(s,{name:"date_range"}),o[25]||(o[25]=u(" Período de Facturación "))]),l("div",Re,[t(p,{modelValue:n.value.billing_period.start_date,"onUpdate:modelValue":o[6]||(o[6]=e=>n.value.billing_period.start_date=e),type:"date",label:"Fecha Inicio",outlined:"",required:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"event"})]),_:1},8,["modelValue"]),t(p,{modelValue:n.value.billing_period.start_time,"onUpdate:modelValue":o[7]||(o[7]=e=>n.value.billing_period.start_time=e),type:"time",label:"Hora Inicio",outlined:"",required:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"schedule"})]),_:1},8,["modelValue"]),t(p,{modelValue:n.value.billing_period.end_date,"onUpdate:modelValue":o[8]||(o[8]=e=>n.value.billing_period.end_date=e),type:"date",label:"Fecha Fin",outlined:"",required:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"event"})]),_:1},8,["modelValue"]),t(p,{modelValue:n.value.billing_period.end_time,"onUpdate:modelValue":o[9]||(o[9]=e=>n.value.billing_period.end_time=e),type:"time",label:"Hora Fin",outlined:"",required:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"schedule"})]),_:1},8,["modelValue"])])]),l("div",Ge,[l("div",He,[t(s,{name:"person"}),o[26]||(o[26]=u(" Información del Cliente "))]),t(P,{modelValue:y.value,"onUpdate:modelValue":[o[10]||(o[10]=e=>y.value=e),ne],options:U.value,"option-label":"names",label:"Seleccionar Cliente",outlined:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"person"})]),option:i(e=>[t(he,ge(ye(e.itemProps)),{default:i(()=>[t(xe,null,{default:i(()=>[t(j,null,{default:i(()=>[u(g(e.opt.names),1)]),_:2},1024),t(j,{caption:""},{default:i(()=>[u(g(e.opt.identification),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options"])]),l("div",Ke,[l("div",We,[t(s,{name:"inventory_2"}),o[27]||(o[27]=u(" Productos ")),t(qe),t(_,{color:"primary",label:"Agregar Producto",onClick:le,icon:"add",flat:"",class:"action-button"})]),(M(!0),S(be,null,Ve(n.value.items,(e,d)=>(M(),S("div",{key:d,class:"items-table q-mb-md"},[l("div",Xe,[l("div",Ze,g(e.name),1),t(_,{icon:"close",flat:"",dense:"",color:"negative",onClick:r=>se(d),class:"action-button"},{default:i(()=>[t(I,null,{default:i(()=>o[28]||(o[28]=[u("Eliminar producto")])),_:1})]),_:2},1032,["onClick"])]),l("div",Je,[t(p,{modelValue:e.quantity,"onUpdate:modelValue":r=>e.quantity=r,modelModifiers:{number:!0},type:"number",label:"Cantidad",outlined:"",dense:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"numbers"})]),_:2},1032,["modelValue","onUpdate:modelValue"]),t(p,{modelValue:e.price,"onUpdate:modelValue":r=>e.price=r,modelModifiers:{number:!0},type:"number",label:"Precio",outlined:"",dense:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"attach_money"})]),_:2},1032,["modelValue","onUpdate:modelValue"]),t(p,{modelValue:e.discount_rate,"onUpdate:modelValue":r=>e.discount_rate=r,modelModifiers:{number:!0},type:"number",label:"Descuento (%)",outlined:"",dense:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"discount"})]),_:2},1032,["modelValue","onUpdate:modelValue"]),t(p,{modelValue:e.tax_rate,"onUpdate:modelValue":r=>e.tax_rate=r,label:"IVA (%)",outlined:"",dense:"",readonly:"",class:"form-field"},{prepend:i(()=>[t(s,{name:"percent"})]),_:2},1032,["modelValue","onUpdate:modelValue"])])]))),128))]),l("div",Ye,[l("div",ea,[t(s,{name:"notes"}),o[29]||(o[29]=u(" Observaciones "))]),t(p,{modelValue:n.value.observation,"onUpdate:modelValue":o[11]||(o[11]=e=>n.value.observation=e),type:"textarea",label:"Observaciones",outlined:"",class:"full-width"},{prepend:i(()=>[t(s,{name:"comment"})]),_:1},8,["modelValue"])])]),_:1})]),_:1}),t(G,{align:"right",class:"modal-footer"},{default:i(()=>[$(t(_,{flat:"",label:"Cancelar",color:"negative",onClick:O,icon:"close",class:"action-button",disable:v.value},null,8,["disable"]),[[H]]),t(_,{color:"primary",label:v.value?"Procesando...":"Generar Factura",onClick:A,loading:v.value,disable:v.value||!n.value.items.length||!y.value,icon:"save",class:"action-button"},{loading:i(()=>[t(Pe)]),_:1},8,["label","loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(B,{modelValue:w.value,"onUpdate:modelValue":o[14]||(o[14]=e=>w.value=e)},{default:i(()=>[t(R,{style:{width:"900px","max-width":"90vw"}},{default:i(()=>[t(Q,{class:"modal-header"},{default:i(()=>[l("div",aa,[t(s,{name:"inventory_2",class:"q-mr-sm"}),o[30]||(o[30]=u(" Seleccionar Productos "))])]),_:1}),t(Q,{class:"q-pa-none"},{default:i(()=>[t(L,{rows:D.value,columns:ee,"row-key":"id",selection:"multiple",selected:h.value,"onUpdate:selected":o[13]||(o[13]=e=>h.value=e),pagination:{rowsPerPage:5},class:"items-table"},{"body-cell-price":i(e=>[t(q,{props:e},{default:i(()=>[u(g(E(e.value)),1)]),_:2},1032,["props"])]),_:1},8,["rows","selected"])]),_:1}),t(G,{align:"right",class:"modal-footer"},{default:i(()=>[$(t(_,{flat:"",label:"Cancelar",color:"negative",icon:"close",class:"action-button"},null,512),[[H]]),t(_,{color:"primary",label:"Agregar Seleccionados",onClick:re,icon:"add",class:"action-button"})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{va as default};
