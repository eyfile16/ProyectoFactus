import{r as J,l as lt,a0 as rt,u as it,h as dt,c as y,S as C,T as i,V as a,b as e,o as d,a1 as b,f as ut,X as s,Z as f,W as V,$ as r,F as ct,d as mt}from"./index-ConCm_F-.js";import{d as pt,Q as vt,b as S,e as W}from"./QTable-BUWrZeTf.js";import{Q as ft,a as _}from"./QCard-BirL4X1V.js";import{Q as w,l as _t,m as gt,n as yt}from"./format-MEHmbXNd.js";import{C as bt,Q as xt}from"./axios2-DnkUwo0C.js";import{Q as Dt}from"./QSpinnerDots-fUqsc9C3.js";import{u as Ct}from"./use-quasar-CWqgSqmt.js";import{i as K}from"./axios-R6vW24p9.js";import{_ as wt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-dark-Df08ketR.js";import"./index-DW_MHI2K.js";const It={class:"invoice-detail-container"},qt={class:"flex justify-between items-center"},Tt={class:"title"},Et={class:"invoice-meta q-mt-md"},Nt={class:"row"},At={class:"col-xs-12 col-sm-6"},Rt={class:"col-xs-12 col-sm-6"},kt={class:"row q-mt-xs"},ht={class:"col-xs-12 col-sm-6"},Ft={class:"col-xs-12 col-sm-6"},Qt={class:"section"},Pt={class:"section-title"},Bt={key:0},Lt={key:1},Vt={key:2},St={key:3},Ot={class:"section"},Ut={class:"section-title"},zt={class:"section"},Mt={class:"section-title"},$t={class:"section totals-section"},jt={class:"section-title"},Gt={class:"total-row"},Jt={class:"total-row"},Wt={class:"total-row"},Kt={class:"total-row"},Xt={class:"total-row grand-total"},Zt={class:"section"},Ht={class:"section-title"},Yt={key:0},te={class:"section"},ee={class:"section-title"},oe={class:"section"},ae={class:"section-title text-negative"},se={class:"section-title"},ne={class:"qr-code-container q-my-md"},le={class:"dian-info"},re={key:1,class:"flex flex-center column q-pa-xl"},ie={__name:"InvoiceDetail",setup(de){const X=rt(),h=it(),U=Ct(),o=J(null),O=J(!0),Z=[{id:"1",name:"Contado"},{id:"2",name:"Crédito"},{id:"10",name:"Efectivo"},{id:"20",name:"Cheque"},{id:"30",name:"Transferencia"},{id:"40",name:"Tarjeta Crédito"},{id:"50",name:"Tarjeta Débito"}],H=[{name:"name",label:"Descripción",field:"name",align:"left",style:"width: 40%"},{name:"quantity",label:"Cant.",field:"quantity",align:"center"},{name:"price",label:"P. Unit.",field:"price",align:"right"},{name:"discount_rate",label:"Desc. %",field:"discount_rate",align:"center"},{name:"tax_rate",label:"IVA %",field:"tax_rate",align:"center"},{name:"total_value",label:"Valor Total",field:"total_value",align:"right",style:"width: 20%"}];lt(async()=>{const l=X.params.id;l?await Y(l):(U.notify({type:"negative",message:"No se proporcionó ID de factura.",position:"top"}),h.push({name:"GenerarFacturas"})),O.value=!1});async function Y(l){var t,n,u,g,D,q,v,T,F,Q,E,N,k,A,P,$,j;O.value=!0;try{if((t=h.currentRoute.value.meta)!=null&&t.invoiceData)o.value=h.currentRoute.value.meta.invoiceData,console.log("Invoice data loaded from route state:",o.value);else try{console.log("Buscando factura con ID:",l);const c=await K.get("/v1/bills");console.log("Respuesta de lista de facturas:",c.data);const G=((u=(n=c.data)==null?void 0:n.data)==null?void 0:u.data)||[];console.log("Lista de facturas encontradas:",G);const B=G.find(m=>m.id===parseInt(l));if(console.log("Factura encontrada:",B),!B)throw new Error(`No se encontró la factura con ID ${l}`);console.log("Buscando detalles con number:",B.number);const L=await K.get(`/v1/bills/show/${B.number}`);if(console.log("Respuesta de detalles de factura:",L.data),((g=L.data)==null?void 0:g.status)==="OK"&&((q=(D=L.data)==null?void 0:D.data)!=null&&q.bill)){const m=L.data.data,p=m.bill;console.log("Datos de factura transformados:",m),o.value={number:p.number||"",reference_code:p.reference_code||"",status:p.status||"",created_at:p.created_at||"",total:p.total||0,observation:p.observation||"",errors:p.errors||[],qr:p.qr||"",cufe:p.cufe||"",payment_method_code:((v=p.payment_method)==null?void 0:v.code)||"",payment_form:p.payment_method||null,names:((T=m.customer)==null?void 0:T.graphic_representation_name)||"",identification:((F=m.customer)==null?void 0:F.identification)||"",customer_details:{email:((Q=m.customer)==null?void 0:Q.email)||"",address:((E=m.customer)==null?void 0:E.address)||"",phone:((N=m.customer)==null?void 0:N.phone)||"",identification_document:((k=m.customer)==null?void 0:k.identification_document)||null},items:((A=m.items)==null?void 0:A.map(R=>({name:R.name,quantity:R.quantity,price:R.price,discount_rate:R.discount_rate,tax_rate:R.tax_rate,total_value:R.total})))||[]},console.log("Invoice value final:",o.value)}else throw new Error("No se pudieron obtener los datos de la factura.")}catch(c){throw console.error("Error completo de la API:",c),console.error("Respuesta de error:",(P=c.response)==null?void 0:P.data),(j=($=c.response)==null?void 0:$.data)!=null&&j.message?new Error(c.response.data.message):c}}catch(c){console.error("Error completo al obtener detalles:",c),U.notify({type:"negative",message:"Error al cargar los detalles de la factura: "+c.message,position:"top",timeout:5e3}),o.value=null}finally{O.value=!1}}const I=dt(()=>{if(!o.value||!o.value.items||o.value.items.length===0)return{subtotal:0,totalDiscount:0,taxableBase:0,totalIVA:0,averageTaxRate:0};let l=0,t=0,n=0,u=0,g=0;o.value.items.forEach(v=>{const T=parseFloat(v.price)||0,F=parseInt(v.quantity)||0,Q=parseFloat(v.discount_rate)||0,E=parseFloat(v.tax_rate)||0,N=T*F,k=N*(Q/100),A=N-k,P=A*(E/100);l+=N,t+=k,n+=P,E>0&&(u+=A*E,g+=A)});const D=l-t,q=g>0?u/g:0;return{subtotal:l,totalDiscount:t,taxableBase:D,totalIVA:n,averageTaxRate:q}}),x=l=>new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:2}).format(l||0),tt=l=>{const t=l.quantity||0,n=l.price||0,u=l.discount_rate||0,g=l.tax_rate||0,D=t*n,q=D*(u/100),v=D-q,T=v*(g/100);return v+T},z=(l,t=!0)=>{if(!l)return"N/A";const n=new Date(l),u={year:"numeric",month:"long",day:"numeric",...t&&{hour:"2-digit",minute:"2-digit"}};return new Intl.DateTimeFormat("es-CO",u).format(n)},et=l=>({DRAFT:"grey",PENDING:"orange",ACCEPTED:"green",REJECTED:"red",CANCELLED:"red"})[l]||"grey",ot=l=>({DRAFT:"Borrador",PENDING:"Pendiente",ACCEPTED:"Aceptada",REJECTED:"Rechazada",CANCELLED:"Cancelada"})[l]||l,at=l=>{const t=Z.find(n=>n.id===l);return t?t.name:"No especificado"},M=()=>{h.back()},st=()=>{window.print()},nt=()=>{window.open("https://catalogo-vpfe.dian.gov.co/","_blank")};return(l,t)=>(d(),y("div",It,[o.value?(d(),C(ft,{key:0,class:"invoice-card"},{default:i(()=>[a(_,{class:"header"},{default:i(()=>[e("div",qt,[e("h2",Tt,[a(f,{name:"receipt_long",class:"q-mr-sm"}),t[0]||(t[0]=s(" Detalle de Factura "))]),ut(a(V,{flat:"",round:"",icon:"close",onClick:M},null,512),[[bt]])]),e("div",Et,[e("div",Nt,[e("div",At,[t[1]||(t[1]=e("strong",null,"Factura N°:",-1)),s(" "+r(o.value.number),1)]),e("div",Rt,[t[2]||(t[2]=e("strong",null,"Fecha:",-1)),s(" "+r(z(o.value.created_at)),1)])]),e("div",kt,[e("div",ht,[t[3]||(t[3]=e("strong",null,"Referencia:",-1)),s(" "+r(o.value.reference_code),1)]),e("div",Ft,[t[4]||(t[4]=e("strong",null,"Estado:",-1)),a(pt,{color:et(o.value.status),"text-color":"white",size:"sm",class:"q-ml-xs"},{default:i(()=>[s(r(ot(o.value.status)),1)]),_:1},8,["color"])])])])]),_:1}),a(w),a(_,null,{default:i(()=>{var n;return[e("div",Qt,[e("h3",Pt,[a(f,{name:"person",class:"q-mr-xs"}),t[5]||(t[5]=s("Cliente"))]),e("p",null,[t[6]||(t[6]=e("strong",null,"Nombre:",-1)),s(" "+r(o.value.names),1)]),e("p",null,[t[7]||(t[7]=e("strong",null,"Identificación:",-1)),s(" "+r(o.value.identification),1)]),o.value.customer_details?(d(),y("p",Bt,[t[8]||(t[8]=e("strong",null,"Email:",-1)),s(" "+r(o.value.customer_details.email||"N/A"),1)])):b("",!0),o.value.customer_details?(d(),y("p",Lt,[t[9]||(t[9]=e("strong",null,"Dirección:",-1)),s(" "+r(o.value.customer_details.address||"N/A"),1)])):b("",!0),o.value.customer_details?(d(),y("p",Vt,[t[10]||(t[10]=e("strong",null,"Teléfono:",-1)),s(" "+r(o.value.customer_details.phone||"N/A"),1)])):b("",!0),(n=o.value.customer_details)!=null&&n.identification_document?(d(),y("p",St,[t[11]||(t[11]=e("strong",null,"Tipo Documento Cliente:",-1)),s(" "+r(o.value.customer_details.identification_document.name||"No especificado"),1)])):b("",!0)])]}),_:1}),a(w),o.value.items&&o.value.items.length?(d(),C(_,{key:0},{default:i(()=>[e("div",Ot,[e("h3",Ut,[a(f,{name:"list_alt",class:"q-mr-xs"}),t[12]||(t[12]=s("Productos/Servicios"))]),a(vt,{rows:o.value.items,columns:H,"row-key":"name","hide-bottom":"",flat:"",bordered:"",dense:"",class:"items-detail-table"},{"body-cell-price":i(n=>[a(S,{props:n},{default:i(()=>[s(r(x(n.row.price)),1)]),_:2},1032,["props"])]),"body-cell-discount_rate":i(n=>[a(S,{props:n},{default:i(()=>[s(r(n.row.discount_rate||0)+"%",1)]),_:2},1032,["props"])]),"body-cell-tax_rate":i(n=>[a(S,{props:n},{default:i(()=>[s(r(n.row.tax_rate||0)+"%",1)]),_:2},1032,["props"])]),"body-cell-total_value":i(n=>[a(S,{props:n,class:"text-right"},{default:i(()=>[s(r(x(tt(n.row))),1)]),_:2},1032,["props"])]),_:1},8,["rows"])])]),_:1})):(d(),C(_,{key:1},{default:i(()=>[e("div",zt,[e("h3",Mt,[a(f,{name:"list_alt",class:"q-mr-xs"}),t[13]||(t[13]=s("Productos/Servicios"))]),t[14]||(t[14]=e("p",null,"No hay ítems disponibles para esta factura.",-1))])]),_:1})),a(w),a(_,null,{default:i(()=>[e("div",$t,[e("h3",jt,[a(f,{name:"paid",class:"q-mr-xs"}),t[15]||(t[15]=s("Totales"))]),e("div",Gt,[t[16]||(t[16]=e("span",null,"Subtotal:",-1)),t[17]||(t[17]=s()),e("strong",null,r(x(I.value.subtotal)),1)]),e("div",Jt,[t[18]||(t[18]=e("span",null,"Descuento Total:",-1)),t[19]||(t[19]=s()),e("strong",null,r(x(I.value.totalDiscount)),1)]),e("div",Wt,[t[20]||(t[20]=e("span",null,"Base Imponible:",-1)),t[21]||(t[21]=s()),e("strong",null,r(x(I.value.taxableBase)),1)]),e("div",Kt,[e("span",null,"IVA Total ("+r(I.value.averageTaxRate>0?I.value.averageTaxRate.toFixed(0)+"%":"N/A")+"):",1),t[22]||(t[22]=s()),e("strong",null,r(x(I.value.totalIVA)),1)]),e("div",Xt,[t[23]||(t[23]=e("span",null,"TOTAL FACTURA:",-1)),t[24]||(t[24]=s()),e("strong",null,r(x(o.value.total)),1)])])]),_:1}),a(w),a(_,null,{default:i(()=>{var n;return[e("div",Zt,[e("h3",Ht,[a(f,{name:"payment",class:"q-mr-xs"}),t[25]||(t[25]=s("Información de Pago"))]),e("p",null,[t[26]||(t[26]=e("strong",null,"Forma de Pago:",-1)),s(" "+r(((n=o.value.payment_form)==null?void 0:n.name)||"No especificado"),1)]),e("p",null,[t[27]||(t[27]=e("strong",null,"Método de Pago:",-1)),s(" "+r(at(o.value.payment_method_code)),1)]),o.value.payment_due_date?(d(),y("p",Yt,[t[28]||(t[28]=e("strong",null,"Fecha de Vencimiento:",-1)),s(" "+r(z(o.value.payment_due_date,!1)),1)])):b("",!0)])]}),_:1}),a(w),o.value.observation?(d(),C(_,{key:2},{default:i(()=>[e("div",te,[e("h3",ee,[a(f,{name:"notes",class:"q-mr-xs"}),t[29]||(t[29]=s("Observaciones"))]),e("p",null,r(o.value.observation),1)])]),_:1})):b("",!0),o.value.errors&&o.value.errors.length>0?(d(),C(w,{key:3})):b("",!0),o.value.errors&&o.value.errors.length>0?(d(),C(_,{key:4},{default:i(()=>[e("div",oe,[e("h3",ae,[a(f,{name:"warning",class:"q-mr-xs"}),t[30]||(t[30]=s("Errores DIAN"))]),a(_t,{bordered:"",separator:"",dense:""},{default:i(()=>[(d(!0),y(ct,null,mt(o.value.errors,(n,u)=>(d(),C(gt,{key:u},{default:i(()=>[a(yt,null,{default:i(()=>[a(W,{caption:""},{default:i(()=>[s("Error "+r(u+1),1)]),_:2},1024),a(W,{class:"text-negative"},{default:i(()=>[s(r(n),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])]),_:1})):b("",!0),a(w),a(_,{class:"qr-section"},{default:i(()=>[e("h3",se,[a(f,{name:"qr_code_scanner",class:"q-mr-xs"}),t[31]||(t[31]=s("Verificación DIAN"))]),e("div",ne,[a(f,{name:"qr_code_2",size:"120px",color:"grey-7"}),t[32]||(t[32]=e("p",{class:"text-caption text-grey-7 q-mt-sm"},"QR para validación DIAN (CUFE)",-1))]),e("p",le,[t[33]||(t[33]=s("Utilice el número de factura ")),e("strong",null,r(o.value.number),1),t[34]||(t[34]=s(" o el CUFE (si disponible en los datos) para verificar en el portal de la DIAN."))]),a(V,{color:"primary",outline:"",label:"Verificar en DIAN",icon:"open_in_new",onClick:nt,class:"q-mt-md"})]),_:1}),a(xt,{align:"right",class:"q-pa-md bg-grey-2"},{default:i(()=>[a(V,{flat:"",label:"Cerrar",color:"primary",onClick:M}),a(V,{label:"Imprimir",color:"secondary",icon:"print",onClick:st})]),_:1})]),_:1})):(d(),y("div",re,[a(Dt,{color:"primary",size:"50px"}),t[35]||(t[35]=e("p",{class:"q-mt-md text-grey-8"},"Cargando detalles de la factura...",-1))]))]))}},De=wt(ie,[["__scopeId","data-v-d77112fb"]]);export{De as default};
