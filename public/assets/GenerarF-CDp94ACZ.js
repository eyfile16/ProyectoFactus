import{u as ie,j as re,k as Q,b as N,e as L,f as k,d as I,l as P,i as se}from"./axios2-BRVHIAgh.js";import{g as M,p as R,i as c,U as de,V as ue,j as ce,r as F,h as V,n as B,f as me,W as fe,E as ve,_ as ge,G as _e,K as pe,L as d,o as be,b as u,N as i}from"./index-Cox-IkiC.js";import{e as he,f as xe,g as ye,t as z,i as Se,k as Ie,q as $,r as Ve,h as we,s as O,Q as j,p as G}from"./format-BpzTiw1s.js";import{a as qe}from"./QLayout-lcNX7Hmp.js";import{S as r}from"./sweetalert2.esm.all-CuB8vOb6.js";import{p as Te}from"./apiClient-CTrGz91Y.js";const ke=M({name:"QSlideTransition",props:{appear:Boolean,duration:{type:Number,default:300}},emits:["show","hide"],setup(t,{slots:w,emit:q}){let _=!1,a,s,v=null,f=null,p,T;function x(){a&&a(),a=null,_=!1,v!==null&&(clearTimeout(v),v=null),f!==null&&(clearTimeout(f),f=null),s!==void 0&&s.removeEventListener("transitionend",p),p=null}function g(e,m,b){m!==void 0&&(e.style.height=`${m}px`),e.style.transition=`height ${t.duration}ms cubic-bezier(.25, .8, .50, 1)`,_=!0,a=b}function h(e,m){e.style.overflowY=null,e.style.height=null,e.style.transition=null,x(),m!==T&&q(m)}function l(e,m){let b=0;s=e,_===!0?(x(),b=e.offsetHeight===e.scrollHeight?0:void 0):(T="hide",e.style.overflowY="hidden"),g(e,b,m),v=setTimeout(()=>{v=null,e.style.height=`${e.scrollHeight}px`,p=y=>{f=null,(Object(y)!==y||y.target===e)&&h(e,"show")},e.addEventListener("transitionend",p),f=setTimeout(p,t.duration*1.1)},100)}function o(e,m){let b;s=e,_===!0?x():(T="show",e.style.overflowY="hidden",b=e.scrollHeight),g(e,b,m),v=setTimeout(()=>{v=null,e.style.height=0,p=y=>{f=null,(Object(y)!==y||y.target===e)&&h(e,"hide")},e.addEventListener("transitionend",p),f=setTimeout(p,t.duration*1.1)},100)}return R(()=>{_===!0&&x()}),()=>c(de,{css:!1,appear:t.appear,onEnter:l,onLeave:o},w.default)}}),C=ue({}),Ce=Object.keys(z),E=M({name:"QExpansionItem",props:{...z,...ye,...xe,icon:String,label:String,labelLines:[Number,String],caption:String,captionLines:[Number,String],dense:Boolean,toggleAriaLabel:String,expandIcon:String,expandedIcon:String,expandIconClass:[Array,String,Object],duration:{},headerInsetLevel:Number,contentInsetLevel:Number,expandSeparator:Boolean,defaultOpened:Boolean,hideExpandIcon:Boolean,expandIconToggle:Boolean,switchToggleSide:Boolean,denseToggle:Boolean,group:String,popup:Boolean,headerStyle:[Array,String,Object],headerClass:[Array,String,Object]},emits:[...he,"click","afterShow","afterHide"],setup(t,{slots:w,emit:q}){const{proxy:{$q:_}}=ce(),a=Se(t,_),s=F(t.modelValue!==null?t.modelValue:t.defaultOpened),v=F(null),f=ie(),{show:p,hide:T,toggle:x}=Ie({showing:s});let g,h;const l=V(()=>`q-expansion-item q-item-type q-expansion-item--${s.value===!0?"expanded":"collapsed"} q-expansion-item--${t.popup===!0?"popup":"standard"}`),o=V(()=>t.contentInsetLevel===void 0?null:{["padding"+(_.lang.rtl===!0?"Right":"Left")]:t.contentInsetLevel*56+"px"}),e=V(()=>t.disable!==!0&&(t.href!==void 0||t.to!==void 0&&t.to!==null&&t.to!=="")),m=V(()=>{const n={};return Ce.forEach(S=>{n[S]=t[S]}),n}),b=V(()=>e.value===!0||t.expandIconToggle!==!0),y=V(()=>t.expandedIcon!==void 0&&s.value===!0?t.expandedIcon:t.expandIcon||_.iconSet.expansionItem[t.denseToggle===!0?"denseIcon":"icon"]),K=V(()=>t.disable!==!0&&(e.value===!0||t.expandIconToggle===!0)),Y=V(()=>({expanded:s.value===!0,detailsId:f.value,toggle:x,show:p,hide:T})),A=V(()=>{const n=t.toggleAriaLabel!==void 0?t.toggleAriaLabel:_.lang.label[s.value===!0?"collapse":"expand"](t.label);return{role:"button","aria-expanded":s.value===!0?"true":"false","aria-controls":f.value,"aria-label":n}});B(()=>t.group,n=>{h!==void 0&&h(),n!==void 0&&H()});function J(n){e.value!==!0&&x(n),q("click",n)}function W(n){n.keyCode===13&&U(n,!0)}function U(n,S){S!==!0&&v.value!==null&&v.value.focus(),x(n),ve(n)}function Z(){q("afterShow")}function X(){q("afterHide")}function H(){g===void 0&&(g=re()),s.value===!0&&(C[t.group]=g);const n=B(s,D=>{D===!0?C[t.group]=g:C[t.group]===g&&delete C[t.group]}),S=B(()=>C[t.group],(D,le)=>{le===g&&D!==void 0&&D!==g&&T()});h=()=>{n(),S(),C[t.group]===g&&delete C[t.group],h=void 0}}function ee(){const n={class:[`q-focusable relative-position cursor-pointer${t.denseToggle===!0&&t.switchToggleSide===!0?" items-end":""}`,t.expandIconClass],side:t.switchToggleSide!==!0,avatar:t.switchToggleSide},S=[c(j,{class:"q-expansion-item__toggle-icon"+(t.expandedIcon===void 0&&s.value===!0?" q-expansion-item__toggle-icon--rotated":""),name:y.value})];return K.value===!0&&(Object.assign(n,{tabindex:0,...A.value,onClick:U,onKeyup:W}),S.unshift(c("div",{ref:v,class:"q-expansion-item__toggle-focus q-icon q-focus-helper q-focus-helper--rounded",tabindex:-1}))),c(O,n,()=>S)}function te(){let n;return w.header!==void 0?n=[].concat(w.header(Y.value)):(n=[c(O,()=>[c(Q,{lines:t.labelLines},()=>t.label||""),t.caption?c(Q,{lines:t.captionLines,caption:!0},()=>t.caption):null])],t.icon&&n[t.switchToggleSide===!0?"push":"unshift"](c(O,{side:t.switchToggleSide===!0,avatar:t.switchToggleSide!==!0},()=>c(j,{name:t.icon})))),t.disable!==!0&&t.hideExpandIcon!==!0&&n[t.switchToggleSide===!0?"unshift":"push"](ee()),n}function ae(){const n={ref:"item",style:t.headerStyle,class:t.headerClass,dark:a.value,disable:t.disable,dense:t.dense,insetLevel:t.headerInsetLevel};return b.value===!0&&(n.clickable=!0,n.onClick=J,Object.assign(n,e.value===!0?m.value:A.value)),c(Ve,n,te)}function oe(){return me(c("div",{key:"e-content",class:"q-expansion-item__content relative-position",style:o.value,id:f.value},we(w.default)),[[fe,s.value]])}function ne(){const n=[ae(),c(ke,{duration:t.duration,onShow:Z,onHide:X},oe)];return t.expandSeparator===!0&&n.push(c($,{class:"q-expansion-item__border q-expansion-item__border--top absolute-top",dark:a.value}),c($,{class:"q-expansion-item__border q-expansion-item__border--bottom absolute-bottom",dark:a.value})),n}return t.group!==void 0&&H(),R(()=>{h!==void 0&&h()}),()=>c("div",{class:l.value},[c("div",{class:"q-expansion-item__container relative-position"},ne())])}}),Fe={class:"container"},Le={class:"row q-col-gutter-md"},De={class:"col-12 col-md-6"},Ee={class:"row q-col-gutter-md"},Pe={class:"col-12 col-sm-6"},Be={class:"col-12 col-sm-6"},Oe={class:"col-12"},Ae={class:"col-12 col-sm-6"},Ue={class:"col-12 col-sm-6"},He={class:"col-12"},Qe={class:"row q-col-gutter-md"},Ne={class:"col-12 col-sm-6"},$e={class:"col-12 col-sm-6"},je={class:"col-12 col-sm-6"},Ge={class:"col-12 col-sm-6"},Me={class:"col-12 col-md-6"},Re={__name:"GenerarF",setup(t){const w=F([]),q=F([]),_=F([{label:"Contado",value:1},{label:"Crédito",value:2},{label:"Transferencia Bancaria",value:3},{label:"Tarjeta de Crédito",value:4},{label:"PSE",value:5}]),a=F({numbering_range_id:11111111,reference_code:"",observation:"",payment_form:null,payment_due_date:"",payment_method_code:"",billing_period:{start_date:"",start_time:"00:00:00",end_date:"",end_time:"00:00:00"},customer:"",items:[]}),s=async()=>{try{const l=await N("/usuarios/users");w.value=l}catch(l){console.error("Error al traer usuarios",l)}},v=async()=>{try{const l=await N("/productos");q.value=l}catch(l){console.error("Error al traer productos",l)}},f=()=>{if(!a.value.customer||!a.value.items||a.value.items.length===0)return r.fire({icon:"error",title:"Oops...",text:"Debe seleccionar un usuario y al menos un producto."}),!1;if(!a.value.reference_code.trim())return r.fire({icon:"error",title:"Oops...",text:"Debe ingresar un código de referencia."}),!1;if(!/^[a-zA-Z0-9-_]+$/.test(a.value.reference_code))return r.fire({icon:"error",title:"Formato incorrecto",text:"El código de referencia debe contener solo letras, números, guiones o guiones bajos."}),!1;if(!a.value.payment_form)return r.fire({icon:"error",title:"Oops...",text:"Debe seleccionar una forma de pago."}),!1;if(!a.value.payment_due_date)return r.fire({icon:"error",title:"Oops...",text:"Debe ingresar la fecha de vencimiento del pago."}),!1;const l=new Date;if(new Date(a.value.payment_due_date)<l)return r.fire({icon:"error",title:"Fecha inválida",text:"La fecha de vencimiento debe ser posterior a la fecha actual."}),!1;if(!a.value.payment_method_code)return r.fire({icon:"error",title:"Oops...",text:"Debe ingresar el código del método de pago."}),!1;if(!a.value.billing_period.start_date||!a.value.billing_period.end_date)return r.fire({icon:"error",title:"Oops...",text:"Debe ingresar la fecha de inicio y fin del período de facturación."}),!1;const e=new Date(a.value.billing_period.start_date);return new Date(a.value.billing_period.end_date)<e?(r.fire({icon:"error",title:"Período inválido",text:"La fecha de fin debe ser posterior a la fecha de inicio."}),!1):!a.value.billing_period.start_time||!a.value.billing_period.end_time?(r.fire({icon:"error",title:"Oops...",text:"Debe ingresar la hora de inicio y fin del período de facturación."}),!1):isNaN(a.value.numbering_range_id)||a.value.numbering_range_id<=0?(r.fire({icon:"error",title:"Valor inválido",text:"El ID del rango de numeración debe ser un número positivo."}),!1):!0},p=async()=>{if(!f()){console.error("Validación del formulario fallida");return}try{const l=await se("/Facturas",a.value);r.fire({icon:"success",title:"¡Éxito!",text:"Factura generada con éxito",confirmButtonColor:"#3085d6"})}catch(l){console.error("Error al generar factura:",l),r.fire({icon:"error",title:"Error",text:`Hubo un problema al generar la factura: ${l.message}`})}},T=()=>{const l=new Date,o=l.toISOString().split("T")[0],e=new Date;e.setDate(e.getDate()+30);const m=e.toISOString().split("T")[0],b=`${String(l.getHours()).padStart(2,"0")}:${String(l.getMinutes()).padStart(2,"0")}:00`;a.value={numbering_range_id:11111111,reference_code:`FAC-${Math.floor(Math.random()*1e4)}`,observation:"Factura de prueba",payment_form:1,payment_due_date:m,payment_method_code:"10",billing_period:{start_date:o,start_time:b,end_date:m,end_time:b},customer:"",items:[]}},x=async()=>{try{const l=await fetch("https://api-sandbox.factus.com.co/v1/oauth/token",{method:"HEAD"});return console.log("API de Factus está respondiendo con estado:",l.status),!0}catch(l){return console.error("Error al verificar el estado de la API:",l),!1}},g=async()=>{if(!await x()){r.fire({icon:"error",title:"API no disponible",text:"La API de Factus no está disponible en este momento. Por favor, intente más tarde.",confirmButtonColor:"#d33"});return}try{if(!(await fetch("https://api-sandbox.factus.com.co/v1/oauth/token/verify",{method:"GET",headers:{Authorization:`Bearer ${JSON.parse(localStorage.getItem("administrador")).token}`}})).ok){r.fire({icon:"error",title:"Token inválido",text:"Su sesión ha expirado o el token es inválido. Por favor, inicie sesión nuevamente.",confirmButtonColor:"#d33"});return}}catch(o){console.error("Error al verificar el token:",o),r.fire({icon:"error",title:"Error de verificación",text:"No se pudo verificar su token de autenticación. Por favor, intente nuevamente.",confirmButtonColor:"#d33"});return}h()},h=async()=>{var l,o;if(f())try{const e=await Te("/v1/bills/validate",{numbering_range_id:a.value.numbering_range_id,reference_code:a.value.reference_code,observation:a.value.observation||"",payment_form:a.value.payment_form,payment_due_date:a.value.payment_due_date,payment_method_code:a.value.payment_method_code,billing_period:{start_date:a.value.billing_period.start_date,start_time:a.value.billing_period.start_time,end_date:a.value.billing_period.end_date,end_time:a.value.billing_period.end_time},customer:a.value.customer,items:a.value.items});r.fire({icon:"success",title:"Validación exitosa",text:"La factura ha sido validada correctamente.",confirmButtonColor:"#3085d6"})}catch(e){console.error("Error al validar la factura:",e),r.fire({icon:"error",title:"Error de validación",text:((o=(l=e.response)==null?void 0:l.data)==null?void 0:o.message)||"No se pudo validar la factura. Por favor, verifique los datos e intente nuevamente.",confirmButtonColor:"#d33"})}};return _e(()=>{s(),v(),T()}),(l,o)=>(be(),pe(qe,{view:"hHh LpR fFf"},{default:d(()=>[u("div",Fe,[i(L,{class:"form-card"},{default:d(()=>[i(k,{class:"header-section"},{default:d(()=>o[12]||(o[12]=[u("h3",{class:"title"},"Generar Factura",-1)])),_:1}),i(k,null,{default:d(()=>[u("div",Le,[u("div",De,[i(E,{"expand-separator":"",icon:"receipt",label:"Detalles de la Factura","default-opened":"","header-class":"text-primary text-weight-bold"},{default:d(()=>[i(L,null,{default:d(()=>[i(k,null,{default:d(()=>[u("div",Ee,[u("div",Pe,[i(I,{modelValue:a.value.numbering_range_id,"onUpdate:modelValue":o[0]||(o[0]=e=>a.value.numbering_range_id=e),modelModifiers:{number:!0},type:"number",min:"1",label:"ID del Rango de Numeración",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",Be,[i(I,{modelValue:a.value.reference_code,"onUpdate:modelValue":o[1]||(o[1]=e=>a.value.reference_code=e),type:"text",label:"Código de Referencia",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",Oe,[i(I,{modelValue:a.value.observation,"onUpdate:modelValue":o[2]||(o[2]=e=>a.value.observation=e),type:"textarea",label:"Observación",outlined:"",dense:"",maxlength:"250",class:"q-mb-md"},null,8,["modelValue"])]),u("div",Ae,[i(P,{modelValue:a.value.payment_form,"onUpdate:modelValue":o[3]||(o[3]=e=>a.value.payment_form=e),options:_.value,label:"Forma de Pago","option-value":"value","option-label":"label","emit-value":"","map-options":"",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue","options"])]),u("div",Ue,[i(I,{modelValue:a.value.payment_method_code,"onUpdate:modelValue":o[4]||(o[4]=e=>a.value.payment_method_code=e),type:"text",label:"Código del Método de Pago",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",He,[i(I,{modelValue:a.value.payment_due_date,"onUpdate:modelValue":o[5]||(o[5]=e=>a.value.payment_due_date=e),type:"date",label:"Fecha de Vencimiento del Pago",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])])])]),_:1})]),_:1})]),_:1}),i(E,{"expand-separator":"",icon:"date_range",label:"Período de Facturación","default-opened":"","header-class":"text-primary text-weight-bold",class:"q-mt-md"},{default:d(()=>[i(L,null,{default:d(()=>[i(k,null,{default:d(()=>[u("div",Qe,[u("div",Ne,[i(I,{modelValue:a.value.billing_period.start_date,"onUpdate:modelValue":o[6]||(o[6]=e=>a.value.billing_period.start_date=e),type:"date",label:"Fecha de Inicio",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",$e,[i(I,{modelValue:a.value.billing_period.start_time,"onUpdate:modelValue":o[7]||(o[7]=e=>a.value.billing_period.start_time=e),type:"time",label:"Hora de Inicio",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",je,[i(I,{modelValue:a.value.billing_period.end_date,"onUpdate:modelValue":o[8]||(o[8]=e=>a.value.billing_period.end_date=e),type:"date",label:"Fecha de Fin",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])]),u("div",Ge,[i(I,{modelValue:a.value.billing_period.end_time,"onUpdate:modelValue":o[9]||(o[9]=e=>a.value.billing_period.end_time=e),type:"time",label:"Hora de Fin",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue"])])])]),_:1})]),_:1})]),_:1})]),u("div",Me,[i(E,{"expand-separator":"",icon:"person",label:"Información del Cliente","default-opened":"","header-class":"text-primary text-weight-bold"},{default:d(()=>[i(L,null,{default:d(()=>[i(k,null,{default:d(()=>[i(P,{modelValue:a.value.customer,"onUpdate:modelValue":o[10]||(o[10]=e=>a.value.customer=e),options:w.value,label:"Seleccionar Usuario","option-value":"_id","option-label":"names","emit-value":"","map-options":"",outlined:"",dense:"",class:"q-mb-md"},null,8,["modelValue","options"])]),_:1})]),_:1})]),_:1}),i(E,{"expand-separator":"",icon:"shopping_cart",label:"Productos","default-opened":"","header-class":"text-primary text-weight-bold",class:"q-mt-md"},{default:d(()=>[i(L,null,{default:d(()=>[i(k,null,{default:d(()=>[i(P,{modelValue:a.value.items,"onUpdate:modelValue":o[11]||(o[11]=e=>a.value.items=e),options:q.value,label:"Seleccionar Productos","option-value":"_id","option-label":"name",multiple:"","emit-value":"","map-options":"",outlined:"",dense:"","use-chips":"",class:"q-mb-md"},null,8,["modelValue","options"])]),_:1})]),_:1})]),_:1})])])]),_:1}),i(k,{class:"actions-section"},{default:d(()=>[i(G,{color:"primary",icon:"description",label:"Generar Factura",class:"action-btn",onClick:p}),i(G,{color:"info",icon:"check_circle",label:"Verificar Factura",class:"action-btn q-ml-md",onClick:g})]),_:1})]),_:1})])]),_:1}))}},Xe=ge(Re,[["__scopeId","data-v-d1357b30"]]);export{Xe as default};
